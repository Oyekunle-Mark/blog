<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build and Boot a Custom Linux Kernel</title>
    <meta name="date" content="2024-05-08">
    <meta name="tags" content="C, linux, osdev">
    <!-- Add your CSS here -->
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- For code highlighting -->
    <link rel="stylesheet" href="/static/css/pygments.css">
</head>
<body>
    <article>
        <header>
            <h1>Build and Boot a Custom Linux Kernel</h1>
            <div class="metadata">
                <time datetime="2024-05-08">May 08, 2024</time>
                <div class="tags">
                    
                        <span class="tag">C</span>
                    
                        <span class="tag">linux</span>
                    
                        <span class="tag">osdev</span>
                    
                </div>
            </div>
        </header>
        <div class="content">
            <p>You will expect to run a program after making changes to it. The same is expected even when hacking a kernel. This article will document how to install the required packages and build and run Linux on QEMU along with a pointer to where to get started with debugging the kernel with the GDB debugger.</p>
<p>I will be using a Debian distribution to run all the commands provided. You might need to modify some of them if you are using a non-debian-based distribution.</p>
<h2>Install the required packages</h2>
<p>The kernel is written in C, so we add the usual assortment of C development packages and some osdev-related packages:</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>vim<span class="w"> </span>libncurses5-dev<span class="w"> </span>gcc<span class="w"> </span>make<span class="w"> </span>git<span class="w"> </span>exuberant-ctags<span class="w"> </span>libssl-dev<span class="w"> </span>bison<span class="w"> </span>flex<span class="w"> </span>libelf-dev<span class="w"> </span>bc<span class="w"> </span>dwarves<span class="w"> </span>zstd<span class="w"> </span>git-email<span class="w"> </span>fakeroot
</code></pre></div>

<p>A lot of these packages might already be preinstalled on your machine, depending on your distribution and how minimal your installation was.</p>
<p>Next, we install the QEMU virtual machine as we will be using it to boot and run the kernel:</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>qemu-system
</code></pre></div>

<p>Finally, in the installation phase, we want to install the GDB debugger for debugging the kernel.</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>gdb
</code></pre></div>

<h2>Build the kernel</h2>
<h3>Pull the repository</h3>
<p>First, pull the mainline repository with:</p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>http://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
</code></pre></div>

<p><code>cd</code> into the folder with:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>linux
</code></pre></div>

<h3>Configure the kernel</h3>
<p>We need a config file that would work on an <code>x86_64</code> architecture. You can find the config file that will be used as a base for the <code>x86_64</code> architecture in <code>arch/x86/configs/x86_64_defconfig</code>. </p>
<p>Create one such config file with:</p>
<div class="codehilite"><pre><span></span><code>make<span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>x86_64<span class="w"> </span>x86_64_defconfig
</code></pre></div>

<h3>Build the kernel</h3>
<p><code>make jX</code> will build the kernel, where <code>X</code> is replaced with the number of cores on your machine. On my 6-core computer, I use:</p>
<div class="codehilite"><pre><span></span><code>make<span class="w"> </span>-j6
</code></pre></div>

<p>The kernel will be built into <code>/arch/x86/boot/bzImage</code>.</p>
<h2>Run the kernel</h2>
<p>Boot into the kernel in the VM with:</p>
<div class="codehilite"><pre><span></span><code>kvm<span class="w"> </span>-cpu<span class="w"> </span>host<span class="w"> </span>-hda<span class="w"> </span>/dev/zero<span class="w"> </span>-kernel<span class="w"> </span>arch/x86/boot/bzImage<span class="w"> </span>-append<span class="w"> </span><span class="s2">&quot;console=ttyS0 root=/dev/zero&quot;</span><span class="w"> </span>-serial<span class="w"> </span>stdio<span class="w"> </span>-display<span class="w"> </span>none<span class="w"> </span>-m<span class="w"> </span>1G
</code></pre></div>

<p>That did not go as planned. The kernel panicked because it could not find a root filesystem. Here's a snippet of the output:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="w">    </span><span class="m">1</span>.183672<span class="o">]</span><span class="w"> </span>Kernel<span class="w"> </span>panic<span class="w"> </span>-<span class="w"> </span>not<span class="w"> </span>syncing:<span class="w"> </span>VFS:<span class="w"> </span>Unable<span class="w"> </span>to<span class="w"> </span>mount<span class="w"> </span>root<span class="w"> </span>fs<span class="w"> </span>on<span class="w"> </span>unknown-block<span class="o">(</span><span class="m">0</span>,0<span class="o">)</span>
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.184077<span class="o">]</span><span class="w"> </span>CPU:<span class="w"> </span><span class="m">0</span><span class="w"> </span>PID:<span class="w"> </span><span class="m">1</span><span class="w"> </span>Comm:<span class="w"> </span>swapper/0<span class="w"> </span>Not<span class="w"> </span>tainted<span class="w"> </span><span class="m">6</span>.9.0-rc7-00136-gf4345f05c0df<span class="w"> </span><span class="c1">#1</span>
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.184469<span class="o">]</span><span class="w"> </span>Hardware<span class="w"> </span>name:<span class="w"> </span>QEMU<span class="w"> </span>Standard<span class="w"> </span>PC<span class="w"> </span><span class="o">(</span>i440FX<span class="w"> </span>+<span class="w"> </span>PIIX,<span class="w"> </span><span class="m">1996</span><span class="o">)</span>,<span class="w"> </span>BIOS<span class="w"> </span><span class="m">1</span>.16.2-debian-1.16.2-1<span class="w"> </span><span class="m">04</span>/01/2014
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.184937<span class="o">]</span><span class="w"> </span>Call<span class="w"> </span>Trace:
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.185073<span class="o">]</span><span class="w">  </span>&lt;TASK&gt;
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.185186<span class="o">]</span><span class="w">  </span>panic+0x31d/0x350
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.185348<span class="o">]</span><span class="w">  </span>mount_root_generic+0x20e/0x340
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.185560<span class="o">]</span><span class="w">  </span>prepare_namespace+0x64/0x280
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.185762<span class="o">]</span><span class="w">  </span>kernel_init_freeable+0x286/0x2d0
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.185982<span class="o">]</span><span class="w">  </span>?<span class="w"> </span>__pfx_kernel_init+0x10/0x10
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.186189<span class="o">]</span><span class="w">  </span>kernel_init+0x15/0x1b0
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.186368<span class="o">]</span><span class="w">  </span>ret_from_fork+0x2c/0x50
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.186552<span class="o">]</span><span class="w">  </span>?<span class="w"> </span>__pfx_kernel_init+0x10/0x10
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.186758<span class="o">]</span><span class="w">  </span>ret_from_fork_asm+0x1a/0x30
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.186958<span class="o">]</span><span class="w">  </span>&lt;/TASK&gt;
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.187153<span class="o">]</span><span class="w"> </span>Kernel<span class="w"> </span>Offset:<span class="w"> </span>0x1de00000<span class="w"> </span>from<span class="w"> </span>0xffffffff81000000<span class="w"> </span><span class="o">(</span>relocation<span class="w"> </span>range:<span class="w"> </span>0xffffffff80000000-0xffffffffbfffffff<span class="o">)</span>
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.187680<span class="o">]</span><span class="w"> </span>---<span class="o">[</span><span class="w"> </span>end<span class="w"> </span>Kernel<span class="w"> </span>panic<span class="w"> </span>-<span class="w"> </span>not<span class="w"> </span>syncing:<span class="w"> </span>VFS:<span class="w"> </span>Unable<span class="w"> </span>to<span class="w"> </span>mount<span class="w"> </span>root<span class="w"> </span>fs<span class="w"> </span>on<span class="w"> </span>unknown-block<span class="o">(</span><span class="m">0</span>,0<span class="o">)</span><span class="w"> </span><span class="o">]</span>---
</code></pre></div>

<p>We will need to build a root file system and pass that to QEMU when we boot the kernel.</p>
<h3>Build a root file system</h3>
<p>We will use Buildroot to build a root file system.</p>
<p>First, we navigate to the parent directory of our <code>linux</code> working directory, clone the Buildroot project and cd into it:</p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>git://git.buildroot.net/buildroot
<span class="nb">cd</span><span class="w"> </span>buildroot
</code></pre></div>

<p>We need a <code>.config</code> file before building.</p>
<p>We can create one using the text-based configuration interface with:</p>
<div class="codehilite"><pre><span></span><code>make<span class="w"> </span>menuconfig
</code></pre></div>

<p>Choose <strong>Target options</strong> and ensure you have the <code>i586</code> architecture selected. This was selected by default when I checked under the <strong>Target options -&gt; i586 Architecture variants</strong> options.</p>
<p>Next, navigate back to the first page of the menu and choose <strong>Filesystem images</strong>. Enable the <strong>ext2/3/4 root file system</strong> option. Beneath it, choose the variant option and enable <strong>ext4</strong>.</p>
<p>Save, and exit. This creates the required <code>.config</code> file.</p>
<p>Then, build with:</p>
<div class="codehilite"><pre><span></span><code>make<span class="w"> </span>-j6
</code></pre></div>

<h3>Run QEMU with the kernel and a root file system</h3>
<p>Let's try again, this time we pass our root file system to QEMU.</p>
<div class="codehilite"><pre><span></span><code>kvm<span class="w"> </span>-cpu<span class="w"> </span>host<span class="w"> </span>-hda<span class="w"> </span>../buildroot/output/images/rootfs.ext4<span class="w"> </span>-kernel<span class="w"> </span>arch/x86/boot/bzImage<span class="w"> </span>-append<span class="w"> </span><span class="s2">&quot;root=/dev/sda rw console=ttyS0,115200 acpi=off nokaslr&quot;</span><span class="w"> </span>-serial<span class="w"> </span>stdio<span class="w"> </span>-display<span class="w"> </span>none<span class="w"> </span>-m<span class="w"> </span>2G
</code></pre></div>

<p>We also added the <code>nokaslr</code> option to <em>append</em>. That turns off the <a href="https://lwn.net/Articles/569635/">Linux kernel address space layout randomization</a>.</p>
<p>Buildroot uses <code>root</code> as the default login user without a password.</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="w">    </span><span class="m">1</span>.420582<span class="o">]</span><span class="w"> </span>EXT4-fs<span class="w"> </span><span class="o">(</span>sda<span class="o">)</span>:<span class="w"> </span>mounted<span class="w"> </span>filesystem<span class="w"> </span>60764e06-39d9-40d0-a708-c9a1b09d76e9<span class="w"> </span>r/w<span class="w"> </span>with<span class="w"> </span>ordered<span class="w"> </span>data<span class="w"> </span>mode.<span class="w"> </span>Quota<span class="w"> </span>mode:<span class="w"> </span>none.
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.422351<span class="o">]</span><span class="w"> </span>VFS:<span class="w"> </span>Mounted<span class="w"> </span>root<span class="w"> </span><span class="o">(</span>ext4<span class="w"> </span>filesystem<span class="o">)</span><span class="w"> </span>on<span class="w"> </span>device<span class="w"> </span><span class="m">8</span>:0.
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.423929<span class="o">]</span><span class="w"> </span>devtmpfs:<span class="w"> </span>mounted
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.424876<span class="o">]</span><span class="w"> </span>Freeing<span class="w"> </span>unused<span class="w"> </span>kernel<span class="w"> </span>image<span class="w"> </span><span class="o">(</span>initmem<span class="o">)</span><span class="w"> </span>memory:<span class="w"> </span>2700K
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.425605<span class="o">]</span><span class="w"> </span>Write<span class="w"> </span>protecting<span class="w"> </span>the<span class="w"> </span>kernel<span class="w"> </span>read-only<span class="w"> </span>data:<span class="w"> </span>26624k
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.426781<span class="o">]</span><span class="w"> </span>Freeing<span class="w"> </span>unused<span class="w"> </span>kernel<span class="w"> </span>image<span class="w"> </span><span class="o">(</span>rodata/data<span class="w"> </span>gap<span class="o">)</span><span class="w"> </span>memory:<span class="w"> </span>1484K
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.433053<span class="o">]</span><span class="w"> </span>x86/mm:<span class="w"> </span>Checked<span class="w"> </span>W+X<span class="w"> </span>mappings:<span class="w"> </span>passed,<span class="w"> </span>no<span class="w"> </span>W+X<span class="w"> </span>pages<span class="w"> </span>found.
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.433369<span class="o">]</span><span class="w"> </span>Run<span class="w"> </span>/sbin/init<span class="w"> </span>as<span class="w"> </span>init<span class="w"> </span>process
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.438727<span class="o">]</span><span class="w"> </span>mount<span class="w"> </span><span class="o">(</span><span class="m">52</span><span class="o">)</span><span class="w"> </span>used<span class="w"> </span>greatest<span class="w"> </span>stack<span class="w"> </span>depth:<span class="w"> </span><span class="m">13504</span><span class="w"> </span>bytes<span class="w"> </span>left
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.442316<span class="o">]</span><span class="w"> </span>EXT4-fs<span class="w"> </span><span class="o">(</span>sda<span class="o">)</span>:<span class="w"> </span>re-mounted<span class="w"> </span>60764e06-39d9-40d0-a708-c9a1b09d76e9<span class="w"> </span>r/w.<span class="w"> </span>Quota<span class="w"> </span>mode:<span class="w"> </span>none.
<span class="o">[</span><span class="w">    </span><span class="m">1</span>.444099<span class="o">]</span><span class="w"> </span>mkdir<span class="w"> </span><span class="o">(</span><span class="m">56</span><span class="o">)</span><span class="w"> </span>used<span class="w"> </span>greatest<span class="w"> </span>stack<span class="w"> </span>depth:<span class="w"> </span><span class="m">13288</span><span class="w"> </span>bytes<span class="w"> </span>left
Saving<span class="w"> </span><span class="m">256</span><span class="w"> </span>bits<span class="w"> </span>of<span class="w"> </span>creditable<span class="w"> </span>seed<span class="w"> </span><span class="k">for</span><span class="w"> </span>next<span class="w"> </span>boot
Starting<span class="w"> </span>syslogd:<span class="w"> </span>OK
Starting<span class="w"> </span>klogd:<span class="w"> </span>OK
Running<span class="w"> </span>sysctl:<span class="w"> </span>OK
Starting<span class="w"> </span>network:<span class="w"> </span>OK

Welcome<span class="w"> </span>to<span class="w"> </span>Buildroot
buildroot<span class="w"> </span>login:<span class="w"> </span>root
<span class="c1"># ls</span>
<span class="c1"># pwd</span>
/root
<span class="c1"># whoami</span>
root
<span class="c1"># lsmod</span>
Module<span class="w">                  </span>Size<span class="w">  </span>Used<span class="w"> </span>by<span class="w">    </span>Not<span class="w"> </span>tainted
</code></pre></div>

<p>Now we can successfully boot into the kernel.</p>
<h2>Add the QEMU GDB support</h2>
<p>To debug the kernel with QEMU and GDB, we need to build the kernel with a config file with debugging options enabled. You can update your config with:</p>
<div class="codehilite"><pre><span></span><code>make<span class="w"> </span>menuconfig
</code></pre></div>

<p>Find a specific option you want to turn on or off by pressing <code>/&lt;CONFIG_XXXXX&gt;</code>, press enter to search for the config, and use the numbers presented in the results to locate where to enable/disable the option.</p>
<p>This <a href="https://docs.kernel.org/dev-tools/gdb-kernel-debugging.html">page</a> provides the information required for debugging the kernel(v6.9) and modules via gdb. Follow it to find the config required for kernel debugging, and how to have GDB debug your custom kernel.</p>
<h2>Conclusion and next steps</h2>
<p>Operating system development is a painful undertaking. Even when it involves learning to read and make small changes to the codebase of an already-matured kernel like Linux. The ability to quickly run the kernel in a VM like QEMU and attach GDB to it for debugging makes the experience less of a pain.</p>
<p>For the next steps, I will be diving into <a href="https://amzn.eu/d/cmMIN5d">Understanding the Linux Kernel</a>. The book is dated, but I expect it to be sufficient in getting me from kernel noob to being ready to hack the kernel. You might be seeing more posts from me on the Linux kernel internals as I progress through the book and dive into the implementation of the kernel.</p>
<p>Thanks for following along.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://en.wikipedia.org/wiki/Tmux">Tmux</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
        </div>
    </article>
</body>
</html>